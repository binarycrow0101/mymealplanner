<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Shopping List</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    background: #fafafa;
    color: #333;
  }

  h1 {
    text-align: center;
    margin-bottom: 15px;
  }

  button {
    display: block;
    width: 100%;
    padding: 16px;
    margin: 10px 0;
    background: #0077cc;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    transition: background 0.2s;
  }

  button:hover {
    background: #005fa3;
  }

  .summary {
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .shopping-item {
    padding: 10px 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .shopping-item:hover {
    background: #f1f7ff;
  }

  .checked {
    text-decoration: line-through;
    color: gray;
    background: #e0e0e0 !important;
  }

  .meal-header {
    font-weight: bold;
    margin-top: 15px;
  }

  .empty-message {
    text-align: center;
    color: #777;
    margin-top: 30px;
  }
</style>
</head>
<body>

<h1>Weekly Shopping List</h1>

<div class="summary" id="summary"></div>
<div id="shopping-list"></div>

<button onclick="exportList()">Copy Shopping List</button>
<button onclick="goBack()">Return to Main Page</button>

<script>
let mealsData = [];

// ‚úÖ Fetch shared meal data dynamically
async function loadMealsData() {
  try {
    const response = await fetch('meals.json');
    const data = await response.json();
    mealsData = data.meals || [];
    loadShoppingList();
  } catch (err) {
    console.error("Error loading meals.json:", err);
    document.getElementById('summary').innerHTML = 
      "<p class='empty-message'>‚ùå Could not load meals data. Check your meals.json file.</p>";
  }
}

function getIngredients(mealName) {
  const meal = mealsData.find(m => m.name === mealName);
  return meal && meal.ingredients ? meal.ingredients : ["Ingredients not listed yet"];
}

function loadShoppingList() {
  const mealPlan = JSON.parse(localStorage.getItem('weeklyMealPlan'));
  const summaryDiv = document.getElementById('summary');
  const listDiv = document.getElementById('shopping-list');

  if (!mealPlan) {
    summaryDiv.innerHTML = "<p class='empty-message'>No meal plan found. Please go back and generate one first.</p>";
    return;
  }

  // Summary
  let summaryHTML = "<strong>This Week‚Äôs Meals:</strong><br>";
  for (const [day, meal] of Object.entries(mealPlan)) {
    summaryHTML += `${day}: ${meal}<br>`;
  }
  summaryDiv.innerHTML = summaryHTML;

  // Ingredients List
  listDiv.innerHTML = "";
  for (const [day, meal] of Object.entries(mealPlan)) {
    const header = document.createElement("div");
    header.className = "meal-header";
    header.textContent = `${day}: ${meal}`;
    listDiv.appendChild(header);

    const ingredients = getIngredients(meal);
    ingredients.forEach(ingredient => {
      const itemDiv = document.createElement("div");
      itemDiv.className = "shopping-item";
      itemDiv.textContent = ingredient;
      itemDiv.onclick = () => itemDiv.classList.toggle("checked");
      listDiv.appendChild(itemDiv);
    });
  }
}

// ‚úÖ Polished Export for To Do
function exportList() {
  const mealPlan = JSON.parse(localStorage.getItem('weeklyMealPlan')) || {};
  const allItems = Array.from(document.querySelectorAll('.shopping-item'));
  const uncheckedItems = allItems.filter(item => !item.classList.contains('checked'));

  let exportText = "üõí WEEKLY SHOPPING LIST\n\n";

  for (const [day, meal] of Object.entries(mealPlan)) {
    exportText += `üìÖ ${day.toUpperCase()} ‚Äî ${meal}\n`;
    const ingredients = getIngredients(meal);
    ingredients.forEach(ingredient => {
      const element = uncheckedItems.find(i => i.textContent === ingredient);
      if (element) exportText += `‚Ä¢ ${ingredient}\n`;
    });
    exportText += "\n";
  }

  navigator.clipboard.writeText(exportText).then(() => {
    alert("‚úÖ Shopping list copied! Paste into Microsoft To Do ‚Äî each line will become a new task.");
  }).catch(() => {
    alert("‚ùå Could not copy to clipboard. Please allow clipboard access.");
  });
}

function goBack() {
  window.location.href = "index.html";
}

// ‚úÖ Load meals on page load
window.onload = loadMealsData;
</script>

</body>
</html>
