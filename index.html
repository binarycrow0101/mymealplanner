<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Meal Generator</title>
<style>
  :root {
    --bg:#0f1724;
    --card:#0b1220;
    --accent:#8b5cf6;
    --text:#f8fafc;
  }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 500px;
    margin: 40px auto;
    text-align: center;
    padding: 10px;
  }
  h1 {
    color: var(--accent);
  }
  .day-card {
    background: var(--card);
    border-radius: 1rem;
    padding: 10px;
    margin: 10px 0;
  }
  button {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 8px 16px;
    margin: 5px;
    cursor: pointer;
  }
  .buttons {
    margin-top: 20px;
  }
  .shopping-link {
    display: inline-block;
    margin-top: 20px;
    text-decoration: none;
    color: var(--accent);
  }
</style>
</head>
<body>
<div class="container">
  <h1>Weekly Meal Generator</h1>
  <div id="mealList"></div>
  <div class="buttons">
    <button id="generateWeek">Generate New Week</button>
  </div>
  <a href="shopping.html" class="shopping-link">View Weekly Shopping List</a>
</div>

<script>
let meals = [];
const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

// Load meals from JSON
fetch("Weeklymealgenerator.json")
  .then(response => response.json())
  .then(data => {
    meals = data;
    loadOrGeneratePlan();
  })
  .catch(err => console.error("Error loading meal data:", err));

// Load from localStorage or generate new week
function loadOrGeneratePlan() {
  const savedPlan = localStorage.getItem("mealPlan");
  if (savedPlan) {
    renderWeek(JSON.parse(savedPlan));
  } else {
    generateWeek();
  }
}

// Generate a new week plan
function generateWeek() {
  const plan = {};
  const usedMeals = new Set();

  daysOfWeek.forEach(day => {
    let possibleMeals = meals.filter(m => {
      const allowedDays = m.Days.map(d => d.toLowerCase());
      return allowedDays.includes(day.toLowerCase()) && !usedMeals.has(m.Recipe);
    });

    // Fallback if no valid meals found for the day
    if (possibleMeals.length === 0) {
      possibleMeals = meals.filter(m => !usedMeals.has(m.Recipe));
    }

    const chosen = possibleMeals[Math.floor(Math.random() * possibleMeals.length)];
    usedMeals.add(chosen.Recipe);
    plan[day] = chosen.Recipe;
  });

  localStorage.setItem("mealPlan", JSON.stringify(plan));
  renderWeek(plan);
}

// Display the plan on the page
function renderWeek(plan) {
  const container = document.getElementById("mealList");
  container.innerHTML = "";

  daysOfWeek.forEach(day => {
    const meal = plan[day] || "—";
    const card = document.createElement("div");
    card.className = "day-card";
    card.innerHTML = `
      <h3>${day}</h3>
      <p>${meal}</p>
      <button onclick="rerollMeal('${day}')">↻ Spin</button>
    `;
    container.appendChild(card);
  });
}

// Reroll an individual day's meal
function rerollMeal(day) {
  const plan = JSON.parse(localStorage.getItem("mealPlan"));
  const usedMeals = new Set(Object.values(plan).filter((m, d) => daysOfWeek[d] !== day));

  let possibleMeals = meals.filter(m => {
    const allowedDays = m.Days.map(d => d.toLowerCase());
    return allowedDays.includes(day.toLowerCase()) && !usedMeals.has(m.Recipe);
  });

  if (possibleMeals.length === 0) {
    possibleMeals = meals.filter(m => !usedMeals.has(m.Recipe));
  }

  const chosen = possibleMeals[Math.floor(Math.random() * possibleMeals.length)];
  plan[day] = chosen.Recipe;

  localStorage.setItem("mealPlan", JSON.stringify(plan));
  renderWeek(plan);
}

// Button: Generate new week
document.getElementById("generateWeek").addEventListener("click", generateWeek);
</script>
</body>
</html>
