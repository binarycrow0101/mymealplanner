<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Super Polished Meal Planner</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    background: #fafafa;
    color: #333;
  }

  h1 {
    text-align: center;
    margin-bottom: 10px;
  }

  /* Only apply large blue style to main buttons */
  button:not(.menu-btn) {
    display: block;
    width: 100%;
    padding: 18px;
    margin: 15px 0;
    background: #0077cc;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    transition: background 0.2s;
  }

  button:not(.menu-btn):hover {
    background: #005fa3;
  }

  /* Each meal row is a flex container: left text, right actions */
  .meal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 8px 0;
    padding: 14px 16px;
    border-radius: 10px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    position: relative;
  }

  .meal:hover { background: #f1f7ff; }
  .meal:active { transform: scale(0.98); }

  .meal-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 0; /* allow text truncation if needed */
  }

  .meal-left strong { width: 90px; flex-shrink: 0; } /* day label fixed width */

  .meal-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* small action area to the right; relative so menu can be absolute to it */
  .meal-actions {
    position: relative;
    flex: 0 0 auto;
    margin-left: 8px;
  }

  .menu-btn {
    background: transparent;
    color: #555;
    border: none;
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    padding: 6px;
    border-radius: 6px;
    transition: background 0.15s, transform 0.12s, color 0.15s;
  }

  .menu-btn:hover {
    background: #eef6ff;
    color: #0077cc;
    transform: scale(1.08);
  }

  .dropdown-menu {
    position: absolute;
    right: 0;
    top: calc(100% + 6px);
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    z-index: 2000;
    max-height: 220px;
    overflow-y: auto;
    padding: 6px 0;
    min-width: 220px;
    animation: fadeIn 0.12s ease forwards;
    transform-origin: top right;
    opacity: 0; transform: scale(0.97);
  }

  @keyframes fadeIn {
    to { opacity: 1; transform: scale(1); }
  }

  .dropdown-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
  }

  .dropdown-item:hover {
    background: #eef6ff;
  }

  .highlight {
    animation: flash 0.4s ease;
  }

  @keyframes flash {
    from { background-color: #c8e6c9; }
    to { background-color: white; }
  }

  .healthy-label {
    font-weight: bold;
    margin-top: 10px;
    text-align: center;
    color: #2e7d32;
  }

  .seed-box {
    text-align: center;
    margin-bottom: 10px;
  }

  .seed-input {
    width: 120px;
    padding: 6px;
    margin-right: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Weekly Meal Planner</h1>

<div class="seed-box">
  <input type="number" id="seedInput" class="seed-input" placeholder="Enter seed">
  <button onclick="loadFromSeed()">Load Seed</button>
</div>

<button onclick="generateMealPlan()">Generate New Meal Plan</button>
<button onclick="openShoppingList()">View Shopping List</button>

<div id="meal-plan"></div>

<script>
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

const meals = [
  {name:"General Tso Chicken",days:["Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Asian"},
  {name:"Taco's",days:["Tuesday","Thursday"],health:3,core:"Turkey",type:"Mexican"},
  {name:"Jambalaya",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Chicken",type:"Rice"},
  {name:"Jerk Chicken",days:["Monday","Tuesday","Thursday","Friday"],health:4,core:"Chicken",type:"Rice"},
  {name:"Pasta and Red Sauce",days:["Wednesday"],health:3,core:"Veggie",type:"Pasta"},
  {name:"Cheddar Broccoli",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Veggie",type:"Soup"},
  {name:"Fish Burgers",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Veggie",type:"Burger"},
  {name:"Stir Fry",days:["Monday","Tuesday","Thursday","Friday"],health:5,core:"Mixed",type:"Asian"},
  {name:"Rotisserie Chicken",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Chicken",type:"Roast"},
  {name:"Take Out",days:["Friday","Saturday"],health:1,core:"Mixed",type:"Any"},
  {name:"Chicken Souvlaki",days:["Monday","Tuesday","Thursday","Friday"],health:4,core:"Chicken",type:"Greek"},
  {name:"Avacado Toast",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:4,core:"Veggie",type:"Breakfast"},
  {name:"Chicken parm",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:2,core:"Chicken",type:"Pasta"},
  {name:"Roast Chicken",days:["Sunday"],health:4,core:"Chicken",type:"Roast"},
  {name:"Tomato Basil Chicken",days:["Saturday","Sunday"],health:4,core:"Chicken",type:"Roast"},
  {name:"Minestrone soup",days:["Saturday","Sunday"],health:5,core:"Veggie",type:"Soup"},
  {name:"Artichoke risotto",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Veggie",type:"Risotto"},
  {name:"Pizza",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Veggie",type:"Pizza"},
  {name:"Salad",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:5,core:"Veggie",type:"Salad"},
  {name:"Fajitas",days:["Tuesday","Thursday"],health:4,core:"Chicken",type:"Mexican"},
  {name:"Spaghetti Meatballs",days:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Pasta"},
  {name:"Cheese and Biscuits",days:["Friday","Saturday","Sunday"],health:1,core:"Mixed",type:"Snacky"},
  {name:"Buffalo Wing Dip",days:["Saturday","Sunday"],health:1,core:"Chicken",type:"Snacky"},
  {name:"BBQ pasta",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Pasta"},
  {name:"Salmon",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:5,core:"Fish",type:"Asian"},
  {name:"Garlic Noodles",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Mixed",type:"Noodles"},
  {name:"M&S Dine In",days:["Friday","Saturday","Sunday"],health:2,core:"Mixed",type:"Any"},
  {name:"Beef Burgers",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Burger"},
  {name:"Chicken Burgers",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Chicken",type:"Burger"},
  {name:"Turkey Burgers",days:["Friday","Saturday","Sunday"],health:4,core:"Turkey",type:"Burger"},
  {name:"Pasta Bake",days:["Wednesday"],health:2,core:"Veggie",type:"Pasta"},
  {name:"Enchilades",days:["Tuesday","Thursday"],health:3,core:"Mixed",type:"Mexican"},
  {name:"Burrito Bowls",days:["Tuesday","Thursday"],health:4,core:"Mixed",type:"Mexican"},
  {name:"Bangers and Mash",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Mixed",type:"Heavy"},
  {name:"Tuna Casserole",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Fish",type:"Pasta"},
  {name:"Chicken Mackahani",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Indian"},
  {name:"Chicken Korma",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Indian"},
  {name:"Sticky Mushrooms",days:["Friday","Saturday","Sunday"],health:3,core:"Veggie",type:"Asian"},
  {name:"Halloumi Tacos",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:4,core:"Veggie",type:"Mexican"},
];

let currentPlan = [];
let currentSeed = null;

function seededRandom(seed) {
  let x = Math.sin(seed++) * 10000;
  return x - Math.floor(x);
}

function generateMealPlan(seed = Math.floor(Math.random() * 999999)) {
  currentSeed = seed;
  const planDiv = document.getElementById("meal-plan");
  planDiv.innerHTML = "";

  let plan = [];
  let lastCore = null;
  let lastType = null;
  let healthyCount = 0;
  let localSeed = seed;

  while (true) {
    plan = [];
    lastCore = null;
    lastType = null;
    healthyCount = 0;

    for (let day of DAYS) {
      let options = meals.filter(m =>
        m.days.includes(day) &&
        m.core !== lastCore &&
        m.type !== lastType
      );
      if (options.length === 0) options = meals.filter(m => m.days.includes(day));
      const randIndex = Math.floor(seededRandom(localSeed++) * options.length);
      let meal = options[randIndex];
      plan.push({ day, meal });
      lastCore = meal.core;
      lastType = meal.type;
      if (meal.health >= 3) healthyCount++;
    }

    if ((healthyCount / DAYS.length) >= 0.7) break;
  }

  currentPlan = plan;
  currentSeed = Math.floor(Math.random() * 999999);
  saveMealPlan();
  renderPlan();
}

function renderPlan() {
  const planDiv = document.getElementById("meal-plan");
  planDiv.innerHTML = "";
  let healthyCount = 0;

  currentPlan.forEach((entry, index) => {
    if (entry.meal.health >= 3) healthyCount++;

    const div = document.createElement("div");
    div.className = "meal";

    // left side: day + meal text
    const left = document.createElement("div");
    left.className = "meal-left";
    left.onclick = () => rerollMeal(index, div); // clicking left rerolls only
    left.innerHTML = `<strong>${entry.day}</strong><div class="meal-title">${entry.meal.name}</div>`;

    // right side: actions
    const actions = document.createElement("div");
    actions.className = "meal-actions";

    const menuBtn = document.createElement("button");
    menuBtn.className = "menu-btn";
    menuBtn.setAttribute("aria-label", "Open meal chooser");
    menuBtn.textContent = "⋮";
    // stop propagation so parent click (reroll) doesn't run
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleDropdown(actions, entry.day, index);
    });

    actions.appendChild(menuBtn);
    div.appendChild(left);
    div.appendChild(actions);
    planDiv.appendChild(div);
  });

  const healthyLabel = document.createElement("div");
  healthyLabel.className = "healthy-label";
  healthyLabel.textContent = `Healthy meals this week: ${Math.round((healthyCount / DAYS.length) * 100)}% (Seed #${currentSeed})`;
  planDiv.appendChild(healthyLabel);
}

function toggleDropdown(actionsContainer, day, index) {
  // remove any other menu
  document.querySelectorAll(".dropdown-menu").forEach(el => el.remove());

  const menu = document.createElement("div");
  menu.className = "dropdown-menu";
  // store index on menu so items can read correct row even if things re-render
  menu.dataset.rowIndex = String(index);

  const options = meals.filter(m => m.days.includes(day));
  options.forEach((meal) => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = meal.name;
    // store meal name (or index) on the item
    item.dataset.mealName = meal.name;
    item.dataset.rowIndex = String(index);
    item.addEventListener("click", (e) => {
      e.stopPropagation();
      const row = parseInt(item.dataset.rowIndex, 10);
      const mealName = item.dataset.mealName;
      // find the meal object by name (names are unique in your data)
      const chosen = meals.find(m => m.name === mealName);
      if (typeof row === "number" && chosen) {
        chooseMeal(row, chosen);
      }
      // close menu after choosing
      menu.remove();
    });
    menu.appendChild(item);
  });

  actionsContainer.appendChild(menu);

  // click outside to close
  setTimeout(() => {
    function outsideHandler(ev) {
      if (!menu.contains(ev.target) && !actionsContainer.contains(ev.target)) {
        menu.remove();
        document.removeEventListener("click", outsideHandler);
      }
    }
    document.addEventListener("click", outsideHandler);
  }, 10);
}

function chooseMeal(index, meal) {
  // ensure index still valid
  if (index < 0 || index >= currentPlan.length) return;
  currentPlan[index].meal = meal;
  currentSeed = Math.floor(Math.random() * 999999);
  saveMealPlan();
  renderPlan();
}

function rerollMeal(index, element) {
  const day = currentPlan[index].day;
  const prev = currentPlan[index - 1]?.meal;
  const next = currentPlan[index + 1]?.meal;

  let options = meals.filter(m =>
    m.days.includes(day) &&
    m.name !== currentPlan[index].meal.name &&
    m.core !== prev?.core &&
    m.type !== prev?.type &&
    m.core !== next?.core &&
    m.type !== next?.type
  );
  if (options.length === 0) options = meals.filter(m => m.days.includes(day));

  const newMeal = options[Math.floor(Math.random() * options.length)];
  currentPlan[index].meal = newMeal;

  currentSeed = Math.floor(Math.random() * 999999);
  saveMealPlan();

  element.classList.add("highlight");
  setTimeout(() => element.classList.remove("highlight"), 400);
  renderPlan();
}

function saveMealPlan() {
  const mealPlan = {};
  currentPlan.forEach(entry => mealPlan[entry.day] = entry.meal.name);
  localStorage.setItem('weeklyMealPlan', JSON.stringify(mealPlan));
  localStorage.setItem('mealSeed', currentSeed);
}

function openShoppingList() {
  if (currentPlan.length === 0) {
    alert("Please generate your meal plan first!");
    return;
  }
  saveMealPlan();
  window.location.href = 'shopping.html';
}

function loadFromSeed() {
  const input = document.getElementById("seedInput").value;
  if (!input) return alert("Enter a seed number first!");
  generateMealPlan(parseInt(input));
}

window.onload = () => {
  const savedPlan = localStorage.getItem('weeklyMealPlan');
  const savedSeed = localStorage.getItem('mealSeed');
  if (savedPlan && savedSeed) {
    const parsed = JSON.parse(savedPlan);
    currentSeed = parseInt(savedSeed);
    currentPlan = Object.entries(parsed).map(([day, mealName]) => {
      const foundMeal = meals.find(m => m.name === mealName);
      return { day, meal: foundMeal || { name: mealName, health: 0, core: "", type: "" } };
    });
    renderPlan();
  }
};
</script>
</body>
</html>
