<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Meal Planner</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    background: #fafafa;
    color: #333;
  }

  h1 { text-align: center; margin-bottom: 10px; }

  button {
    display: block;
    width: 100%;
    padding: 18px;
    margin: 15px 0;
    background: #0077cc;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    transition: background 0.2s;
  }
  button:hover { background: #005fa3; }

  .meal {
    margin: 8px 0;
    padding: 16px;
    border-radius: 10px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    position: relative;
  }
  .meal:active { transform: scale(0.98); }
  .meal:hover { background: #f1f7ff; }

  .highlight { animation: flash 0.4s ease; }
  @keyframes flash { from { background-color: #c8e6c9; } to { background-color: white; } }

  .healthy-label {
    font-weight: bold;
    margin-top: 10px;
    text-align: center;
    color: #2e7d32;
    cursor: pointer;
  }

  select.meal-select {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    background-color: white;
    z-index: 1000;
    position: relative;
    pointer-events: auto;
  }

  .dropdown-open .meal { pointer-events: none; }
  .dropdown-open select.meal-select { pointer-events: auto; }

  .seed-box {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 35px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    flex-wrap: wrap;
  }

  .seed-input {
    width: 120px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
    font-size: 16px;
  }

  .small-btn {
    padding: 8px 14px;
    font-size: 14px;
    width: auto;
    margin: 0;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h1>Weekly Meal Planner</h1>

<button id="generateBtn" disabled>Generate New Meal Plan</button>
<button id="shoppingBtn" disabled>View Shopping List</button>

<div id="meal-plan"></div>

<div class="seed-box">
  <input type="number" id="seedInput" class="seed-input" placeholder="Enter seed">
  <button class="small-btn" onclick="copySeed()">Copy</button>
  <button class="small-btn" onclick="pasteSeed()">Paste</button>
  <button class="small-btn" onclick="loadFromSeed()">Load</button>
</div>

<script>
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
let meals = [];
let currentPlan = [];
let currentSeed = null;

async function loadMeals() {
  try {
    const response = await fetch('meals.json');
    const data = await response.json();
    meals = data.meals || [];
    console.log("✅ Meals loaded:", meals.length);

    // Enable buttons once data is loaded
    document.getElementById("generateBtn").disabled = false;
    document.getElementById("shoppingBtn").disabled = false;

    initializeApp();
  } catch (err) {
    console.error("❌ Failed to load meals.json:", err);
    alert("Couldn't load meal data. Please ensure meals.json is in the same folder.");
  }
}

window.onload = loadMeals;

function initializeApp() {
  document.getElementById("generateBtn").onclick = () => generateMealPlan();
  document.getElementById("shoppingBtn").onclick = () => openShoppingList();

  const seed = localStorage.getItem('mealSeed');
  const plans = getSavedPlans();
  if (seed && plans[seed]) {
    const saved = plans[seed];
    currentPlan = Object.entries(saved).map(([d, m]) => {
      const f = meals.find(x => x.name === m);
      return { day: d, meal: f || { name: m, health: 0, core: "", type: "" } };
    });
    currentSeed = Number(seed);
    renderPlan();
  } else {
    generateMealPlan();
  }
}

function getSavedPlans() {
  try { return JSON.parse(localStorage.getItem('savedMealPlans')) || {}; }
  catch { return {}; }
}
function savePlans(plans) { localStorage.setItem('savedMealPlans', JSON.stringify(plans)); }
function persistPlan(seed) {
  const p = {};
  currentPlan.forEach(e => p[e.day] = e.meal.name);
  localStorage.setItem('weeklyMealPlan', JSON.stringify(p));
  localStorage.setItem('mealSeed', seed);
  const plans = getSavedPlans();
  plans[String(seed)] = p;
  savePlans(plans);
}

function seededRandom(seed) {
  let x = Math.sin(seed++) * 10000;
  return x - Math.floor(x);
}

function generateMealPlan(seed = Math.floor(Math.random() * 999999)) {
  if (!meals.length) return alert("Meals not loaded yet!");
  seed = Number(seed);
  currentSeed = seed;
  let plan = [], lastCore = null, lastType = null, healthyCount = 0, localSeed = seed;

  while (true) {
    plan = []; lastCore = null; lastType = null; healthyCount = 0;
    for (let day of DAYS) {
      let opts = meals.filter(m => m.days.includes(day) && m.core !== lastCore && m.type !== lastType);
      if (!opts.length) opts = meals.filter(m => m.days.includes(day));
      const meal = opts[Math.floor(seededRandom(localSeed++) * opts.length)];
      plan.push({ day, meal });
      lastCore = meal.core;
      lastType = meal.type;
      if (meal.health >= 3) healthyCount++;
    }
    if (healthyCount / DAYS.length >= 0.7) break;
  }
  currentPlan = plan;
  persistPlan(currentSeed);
  renderPlan();
}

function renderPlan() {
  const div = document.getElementById("meal-plan");
  div.innerHTML = "";
  document.body.classList.remove("dropdown-open");
  document.querySelectorAll("select.meal-select").forEach(s => s.remove());
  let healthyCount = 0;

  currentPlan.forEach((e, i) => {
    if (e.meal.health >= 3) healthyCount++;
    const d = document.createElement("div");
    d.className = "meal";
    d.innerHTML = `<strong>${e.day}</strong>: ${e.meal.name}`;
    d.onclick = () => openSelector(i, d);
    div.appendChild(d);
  });

  const label = document.createElement("div");
  label.className = "healthy-label";
  label.textContent = `Healthy meals this week: ${Math.round((healthyCount / DAYS.length) * 100)}% (Seed #${currentSeed})`;
  label.onclick = copySeed;
  div.appendChild(label);
  document.getElementById("seedInput").value = currentSeed || "";
}

function openSelector(i, div) {
  const day = currentPlan[i].day;
  const opts = meals.filter(m => m.days.includes(day));
  const existing = document.querySelector("select.meal-select");
  if (existing) {
    existing.remove();
    document.body.classList.remove("dropdown-open");
    if (existing.parentElement === div) return;
  }

  const s = document.createElement("select");
  s.className = "meal-select";
  s.innerHTML = opts.map(m =>
    `<option value="${m.name}" ${m.name === currentPlan[i].meal.name ? "selected" : ""}>${m.name}</option>`
  ).join("");

  document.body.classList.add("dropdown-open");
  s.addEventListener("change", e => {
    const sel = meals.find(m => m.name === e.target.value) || { name: e.target.value, health: 0, core: "", type: "" };
    currentPlan[i].meal = sel;
    persistPlan(currentSeed);
    s.remove();
    document.body.classList.remove("dropdown-open");
    renderPlan();
  });

  function close(ev) {
    if (!s.contains(ev.target)) {
      s.remove();
      document.body.classList.remove("dropdown-open");
      document.removeEventListener("click", close);
      document.removeEventListener("touchstart", close);
    }
  }
  setTimeout(() => {
    document.addEventListener("click", close);
    document.addEventListener("touchstart", close);
  }, 10);

  div.appendChild(s);
  try { s.focus(); } catch { }
}

function openShoppingList() {
  if (!currentPlan.length) return alert("Please generate your meal plan first!");
  persistPlan(currentSeed);
  window.location.href = 'shopping.html';
}

function loadFromSeed() {
  const v = document.getElementById("seedInput").value.trim();
  if (!v) return alert("Enter a seed first!");
  loadSeed(v);
}

function loadSeed(seed) {
  seed = String(seed);
  const plans = getSavedPlans();
  if (plans[seed]) {
    const saved = plans[seed];
    currentPlan = Object.entries(saved).map(([d, m]) => {
      const f = meals.find(x => x.name === m);
      return { day: d, meal: f || { name: m, health: 0, core: "", type: "" } };
    });
    currentSeed = Number(seed);
    persistPlan(seed);
    renderPlan();
  } else {
    generateMealPlan(Number(seed));
  }
}

function copySeed() {
  if (!currentSeed) return alert("Generate a plan first!");
  navigator.clipboard.writeText(currentSeed.toString()).then(() => {
    document.getElementById("seedInput").value = currentSeed;
    alert(`Seed #${currentSeed} copied and filled!`);
  });
}

async function pasteSeed() {
  try {
    const text = await navigator.clipboard.readText();
    if (!text) return alert("Clipboard is empty!");
    document.getElementById("seedInput").value = text.trim();
    alert(`Seed ${text.trim()} pasted!`);
  } catch (err) {
    alert("Unable to read clipboard (browser permission may be required).");
  }
}
</script>

</body>
</html>
