<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekly Meal Planner</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    background: #fafafa;
    color: #333;
  }

  h1 { text-align: center; margin-bottom: 10px; }

  button {
    display: block;
    width: 100%;
    padding: 18px;
    margin: 15px 0;
    background: #0077cc;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    transition: background 0.2s;
  }
  button:hover { background: #005fa3; }

  .meal {
    margin: 8px 0;
    padding: 16px;
    border-radius: 10px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    position: relative;
  }
  .meal:active { transform: scale(0.98); }
  .meal:hover { background: #f1f7ff; }

  .highlight { animation: flash 0.4s ease; }
  @keyframes flash { from { background-color: #c8e6c9; } to { background-color: white; } }

  .healthy-label { font-weight: bold; margin-top: 10px; text-align: center; color: #2e7d32; }

  .seed-box { text-align: center; margin-bottom: 10px; }
  .seed-input {
    width: 120px; padding: 6px; margin-right: 8px; border-radius: 6px; border: 1px solid #ccc; text-align: center;
  }

  /* Dropdown styling */
  select.meal-select {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    background-color: white;
    z-index: 1000; /* ensure it overlays */
    position: relative;
    pointer-events: auto;
  }

  /* When a select is open, block clicks on other meal cards */
  .dropdown-open .meal { pointer-events: none; }
  .dropdown-open select.meal-select { pointer-events: auto; }
</style>
</head>
<body>

<h1>Weekly Meal Planner</h1>

<div class="seed-box">
  <input type="number" id="seedInput" class="seed-input" placeholder="Enter seed">
  <button onclick="loadFromSeed()">Load Seed</button>
</div>

<button onclick="generateMealPlan()">Generate New Meal Plan</button>
<button onclick="openShoppingList()">View Shopping List</button>

<div id="meal-plan"></div>

<script>
/* ---------- Data & state ---------- */
const DAYS = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

const meals = [
  {name:"General Tso Chicken",days:["Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Asian"},
  {name:"Taco's",days:["Tuesday","Thursday"],health:3,core:"Turkey",type:"Mexican"},
  {name:"Jambalaya",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Chicken",type:"Rice"},
  {name:"Jerk Chicken",days:["Monday","Tuesday","Thursday","Friday"],health:4,core:"Chicken",type:"Rice"},
  {name:"Pasta and Red Sauce",days:["Wednesday"],health:3,core:"Veggie",type:"Pasta"},
  {name:"Cheddar Broccoli",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Veggie",type:"Soup"},
  {name:"Fish Burgers",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Veggie",type:"Burger"},
  {name:"Stir Fry",days:["Monday","Tuesday","Thursday","Friday"],health:5,core:"Mixed",type:"Asian"},
  {name:"Rotisserie Chicken",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Chicken",type:"Roast"},
  {name:"Take Out",days:["Friday","Saturday"],health:1,core:"Mixed",type:"Any"},
  {name:"Chicken Souvlaki",days:["Monday","Tuesday","Thursday","Friday"],health:4,core:"Chicken",type:"Greek"},
  {name:"Avacado Toast",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:4,core:"Veggie",type:"Breakfast"},
  {name:"Chicken parm",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:2,core:"Chicken",type:"Pasta"},
  {name:"Roast Chicken",days:["Sunday"],health:4,core:"Chicken",type:"Roast"},
  {name:"Tomato Basil Chicken",days:["Saturday","Sunday"],health:4,core:"Chicken",type:"Roast"},
  {name:"Minestrone soup",days:["Saturday","Sunday"],health:5,core:"Veggie",type:"Soup"},
  {name:"Artichoke risotto",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Veggie",type:"Risotto"},
  {name:"Pizza",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Veggie",type:"Pizza"},
  {name:"Salad",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:5,core:"Veggie",type:"Salad"},
  {name:"Fajitas",days:["Tuesday","Thursday"],health:4,core:"Chicken",type:"Mexican"},
  {name:"Spaghetti Meatballs",days:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Pasta"},
  {name:"Cheese and Biscuits",days:["Friday","Saturday","Sunday"],health:1,core:"Mixed",type:"Snacky"},
  {name:"Buffalo Wing Dip",days:["Saturday","Sunday"],health:1,core:"Chicken",type:"Snacky"},
  {name:"BBQ pasta",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Pasta"},
  {name:"Salmon",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:5,core:"Fish",type:"Asian"},
  {name:"Garlic Noodles",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Mixed",type:"Noodles"},
  {name:"M&S Dine In",days:["Friday","Saturday","Sunday"],health:2,core:"Mixed",type:"Any"},
  {name:"Beef Burgers",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Burger"},
  {name:"Chicken Burgers",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Chicken",type:"Burger"},
  {name:"Turkey Burgers",days:["Friday","Saturday","Sunday"],health:4,core:"Turkey",type:"Burger"},
  {name:"Pasta Bake",days:["Wednesday"],health:2,core:"Veggie",type:"Pasta"},
  {name:"Enchilades",days:["Tuesday","Thursday"],health:3,core:"Mixed",type:"Mexican"},
  {name:"Burrito Bowls",days:["Tuesday","Thursday"],health:4,core:"Mixed",type:"Mexican"},
  {name:"Bangers and Mash",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Mixed",type:"Heavy"},
  {name:"Tuna Casserole",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Fish",type:"Pasta"},
  {name:"Chicken Mackahani",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Indian"},
  {name:"Chicken Korma",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Indian"},
  {name:"Sticky Mushrooms",days:["Friday","Saturday","Sunday"],health:3,core:"Veggie",type:"Asian"},
  {name:"Halloumi Tacos",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:4,core:"Veggie",type:"Mexican"},
];

let currentPlan = [];
let currentSeed = null;

/* ---------- Helpers for saved plans ---------- */
function getSavedPlans() {
  try {
    return JSON.parse(localStorage.getItem('savedMealPlans')) || {};
  } catch (e) {
    return {};
  }
}
function savePlansToStorage(plans) {
  localStorage.setItem('savedMealPlans', JSON.stringify(plans));
}

/* Save currentPlan into standard spots and also store under currentSeed if provided */
function persistPlanUnderSeed(seedStr) {
  // create day->mealName object
  const mealPlanObj = {};
  currentPlan.forEach(entry => mealPlanObj[entry.day] = entry.meal.name);

  // store canonical weekly plan & last seed (shopping.html uses these)
  localStorage.setItem('weeklyMealPlan', JSON.stringify(mealPlanObj));
  localStorage.setItem('mealSeed', seedStr);

  // also save into savedMealPlans map so loadFromSeed can restore exact custom plan
  const plans = getSavedPlans();
  plans[seedStr] = mealPlanObj;
  savePlansToStorage(plans);
}

/* ---------- RNG & generation ---------- */
function seededRandom(seed) {
  let x = Math.sin(seed++) * 10000;
  return x - Math.floor(x);
}

/* Generate deterministic plan from a seed (or random seed if none passed).
   IMPORTANT: currentSeed will be set to the seed used to create the plan. */
function generateMealPlan(seed = Math.floor(Math.random() * 999999)) {
  // ensure seed is integer
  seed = Number(seed);
  currentSeed = seed;

  let plan = [];
  let lastCore = null;
  let lastType = null;
  let healthyCount = 0;
  let localSeed = seed;

  while (true) {
    plan = [];
    lastCore = null;
    lastType = null;
    healthyCount = 0;

    for (let day of DAYS) {
      let options = meals.filter(m =>
        m.days.includes(day) &&
        m.core !== lastCore &&
        m.type !== lastType
      );
      if (options.length === 0) options = meals.filter(m => m.days.includes(day));

      const randIndex = Math.floor(seededRandom(localSeed++) * options.length);
      const meal = options[randIndex];
      plan.push({ day, meal });
      lastCore = meal.core;
      lastType = meal.type;
      if (meal.health >= 3) healthyCount++;
    }

    if ((healthyCount / DAYS.length) >= 0.7) break;
    // note: loop will repeat until healthy threshold satisfied
  }

  currentPlan = plan;

  // persist the generated plan under this seed (helps reproduce it later)
  persistPlanUnderSeed(String(currentSeed));

  renderPlan();
}

/* ---------- Rendering & interaction ---------- */
function renderPlan() {
  const planDiv = document.getElementById("meal-plan");
  planDiv.innerHTML = "";
  let healthyCount = 0;

  // ensure body not in dropdown-open state
  document.body.classList.remove("dropdown-open");
  // remove any leftover selects
  document.querySelectorAll("select.meal-select").forEach(s => s.remove());

  currentPlan.forEach((entry, index) => {
    if (entry.meal.health >= 3) healthyCount++;

    const div = document.createElement("div");
    div.className = "meal";
    div.innerHTML = `<strong>${entry.day}</strong>: ${entry.meal.name}`;

    // click opens selector for that day
    div.onclick = () => openMealSelector(index, div);

    planDiv.appendChild(div);
  });

  const healthyLabel = document.createElement("div");
  healthyLabel.className = "healthy-label";
  healthyLabel.textContent = `Healthy meals this week: ${Math.round((healthyCount / DAYS.length) * 100)}% (Seed #${currentSeed})`;
  planDiv.appendChild(healthyLabel);
}

/* Open in-place <select> inside the meal div for full list of meals valid on that day.
   Selecting a meal saves a NEW seed and stores the customised plan under that seed. */
function openMealSelector(index, div) {
  const day = currentPlan[index].day;
  const options = meals.filter(m => m.days.includes(day));

  // Remove any existing selector
  const existingSelect = document.querySelector("select.meal-select");
  if (existingSelect) {
    existingSelect.remove();
    document.body.classList.remove("dropdown-open");
    // if the same div was clicked and selector existed, we simply closed it
    if (existingSelect.parentElement === div) return;
  }

  // create select
  const select = document.createElement("select");
  select.className = "meal-select";
  select.innerHTML = options.map(m => `<option value="${escapeHtml(m.name)}" ${m.name === currentPlan[index].meal.name ? "selected" : ""}>${escapeHtml(m.name)}</option>`).join("");

  // When dropdown open, prevent other meal cards from receiving clicks
  document.body.classList.add("dropdown-open");

  // Change handler: update currentPlan, create new seed and persist mapping
  select.addEventListener("change", (e) => {
    const selectedName = e.target.value;
    const selectedMeal = meals.find(m => m.name === selectedName) || { name: selectedName, health: 0, core: "", type: "" };
    currentPlan[index].meal = selectedMeal;

    // generate new seed for this customised week and persist under that seed
    const newSeed = Math.floor(Math.random() * 999999);
    currentSeed = newSeed;
    persistPlanUnderSeed(String(newSeed));

    // small highlight visual then re-render (select removed in persistPlanUnderSeed)
    div.classList.add("highlight");
    setTimeout(() => div.classList.remove("highlight"), 400);

    // remove select and close dropdown state then re-render
    select.remove();
    document.body.classList.remove("dropdown-open");
    renderPlan();
  }, { passive: true });

  // If user taps outside the select, close it (don't save changes)
  function outsideHandler(ev) {
    if (!select.contains(ev.target)) {
      select.remove();
      document.body.classList.remove("dropdown-open");
      document.removeEventListener("click", outsideHandler);
      document.removeEventListener("touchstart", outsideHandler);
    }
  }

  setTimeout(() => {
    document.addEventListener("click", outsideHandler);
    document.addEventListener("touchstart", outsideHandler);
  }, 10);

  div.appendChild(select);

  // focus the select to open native dropdown on mobile
  try { select.focus({ preventScroll: false }); } catch (e) { select.focus(); }
}

/* ---------- Storage helpers & shopping sync ---------- */
/* save currentPlan into weeklyMealPlan & mealSeed (keeps shopping.html working) */
function saveMealPlanSimple() {
  const mealPlanObj = {};
  currentPlan.forEach(entry => mealPlanObj[entry.day] = entry.meal.name);
  localStorage.setItem('weeklyMealPlan', JSON.stringify(mealPlanObj));
  localStorage.setItem('mealSeed', String(currentSeed));
}

/* Persist plan under currentSeed as well as weeklyMealPlan - convenience wrapper */
function persistCurrentPlan() {
  saveMealPlanSimple();
  // also store under savedMealPlans mapping
  const plans = getSavedPlans();
  const mealPlanObj = {};
  currentPlan.forEach(entry => mealPlanObj[entry.day] = entry.meal.name);
  plans[String(currentSeed)] = mealPlanObj;
  savePlansToStorage(plans);
}

/* Called by "View Shopping List" - ensures latest plan is saved for shopping.html */
function openShoppingList() {
  if (!currentPlan || currentPlan.length === 0) {
    alert("Please generate your meal plan first!");
    return;
  }
  // persist under currentSeed and weeklyMealPlan for shopping page
  persistCurrentPlan();
  window.location.href = 'shopping.html';
}

/* ---------- Load by seed logic ---------- */
/* If a saved custom plan exists for this seed, load it. Otherwise generate deterministically from seed. */
function loadSeedPlan(seedInput) {
  const seed = Number(seedInput);
  const plans = getSavedPlans();
  const key = String(seed);
  if (plans[key]) {
    // load exact saved plan
    const saved = plans[key];
    currentPlan = Object.entries(saved).map(([day, mealName]) => {
      const foundMeal = meals.find(m => m.name === mealName);
      return { day, meal: foundMeal || { name: mealName, health: 0, core: "", type: "" } };
    });
    currentSeed = seed;
    // ensure weeklyMealPlan and mealSeed kept in localStorage for shopping page compatibility
    persistCurrentPlan();
    renderPlan();
  } else {
    // no custom saved plan -> generate deterministically from seed
    generateMealPlan(seed);
  }
}

/* loadFromSeed called by UI */
function loadFromSeed() {
  const input = document.getElementById("seedInput").value;
  if (!input) return alert("Enter a seed number first!");
  loadSeedPlan(parseInt(input, 10));
}

/* ---------- Utility ---------- */
function escapeHtml(unsafe) {
  return unsafe.replace(/[&<"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#39;'}[m]);
  });
}

/* ---------- On first load, restore last plan if present ---------- */
window.onload = () => {
  const savedSeed = localStorage.getItem('mealSeed');
  const savedPlan = localStorage.getItem('weeklyMealPlan');

  if (savedSeed) {
    // if there's a saved custom plan under this seed, prefer that
    const plans = getSavedPlans();
    const key = String(savedSeed);
    if (plans[key]) {
      // restore the saved mapping
      const saved = plans[key];
      currentPlan = Object.entries(saved).map(([day, mealName]) => {
        const foundMeal = meals.find(m => m.name === mealName);
        return { day, meal: foundMeal || { name: mealName, health: 0, core: "", type: "" } };
      });
      currentSeed = Number(savedSeed);
      renderPlan();
      return;
    }
  }

  if (savedPlan) {
    // fallback: load the generic weeklyMealPlan format
    const parsed = JSON.parse(savedPlan);
    currentPlan = Object.entries(parsed).map(([day, mealName]) => {
      const foundMeal = meals.find(m => m.name === mealName);
      return { day, meal: foundMeal || { name: mealName, health: 0, core: "", type: "" } };
    });
    currentSeed = savedSeed ? Number(savedSeed) : null;
    renderPlan();
    return;
  }

  // nothing saved yet: generate a fresh plan
  generateMealPlan();
};
</script>

</body>
</html>
