<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Polished Meal Planner</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    background: #fafafa;
    color: #333;
  }

  h1 {
    text-align: center;
    margin-bottom: 10px;
  }

  button {
    display: block;
    width: 100%;
    padding: 18px;
    margin: 15px 0;
    background: #0077cc;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    transition: background 0.2s;
  }

  button:hover {
    background: #005fa3;
  }

  .meal {
    margin: 8px 0;
    padding: 16px;
    border-radius: 10px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }

  .meal:active {
    transform: scale(0.98);
  }

  .meal:hover {
    background: #f1f7ff;
  }

  .highlight {
    animation: flash 0.4s ease;
  }

  @keyframes flash {
    from { background-color: #c8e6c9; }
    to { background-color: white; }
  }

  .healthy-label {
    font-weight: bold;
    margin-top: 10px;
    text-align: center;
    color: #2e7d32;
  }

  .seed-box {
    text-align: center;
    margin-bottom: 10px;
  }

  .seed-input {
    width: 120px;
    padding: 6px;
    margin-right: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
  }
</style>
</head>
<body>

<h1>Weekly Meal Planner</h1>

<div class="seed-box">
  <input type="number" id="seedInput" class="seed-input" placeholder="Enter seed">
  <button onclick="loadFromSeed()">Load Seed</button>
</div>

<button onclick="generateMealPlan()">Generate New Meal Plan</button>
<button onclick="openShoppingList()">View Shopping List</button>

<div id="meal-plan"></div>

<script>
/* -------------------------
   Data & state
   ------------------------- */
const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

const meals = [
  {name:"General Tso Chicken",days:["Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Asian"},
  {name:"Taco's",days:["Tuesday","Thursday"],health:3,core:"Turkey",type:"Mexican"},
  {name:"Jambalaya",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Chicken",type:"Rice"},
  {name:"Jerk Chicken",days:["Monday","Tuesday","Thursday","Friday"],health:4,core:"Chicken",type:"Rice"},
  {name:"Pasta and Red Sauce",days:["Wednesday"],health:3,core:"Veggie",type:"Pasta"},
  {name:"Cheddar Broccoli",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Veggie",type:"Soup"},
  {name:"Fish Burgers",days:["Monday","Tuesday","Thursday","Friday"],health:3,core:"Fish",type:"Burger"},
  {name:"Stir Fry",days:["Monday","Tuesday","Thursday","Friday"],health:5,core:"Mixed",type:"Asian"},
  {name:"Rotisserie Chicken",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Chicken",type:"Roast"},
  {name:"Take Out",days:["Friday","Saturday"],health:1,core:"Mixed",type:"Any"},
  {name:"Chicken Souvlaki",days:["Monday","Tuesday","Thursday","Friday"],health:4,core:"Chicken",type:"Greek"},
  {name:"Avacado Toast",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:4,core:"Veggie",type:"Breakfast"},
  {name:"Chicken parm",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:2,core:"Chicken",type:"Pasta"},
  {name:"Roast Chicken",days:["Sunday"],health:4,core:"Chicken",type:"Roast"},
  {name:"Tomato Basil Chicken",days:["Saturday","Sunday"],health:4,core:"Chicken",type:"Roast"},
  {name:"Minestrone soup",days:["Saturday","Sunday"],health:5,core:"Veggie",type:"Soup"},
  {name:"Artichoke risotto",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Veggie",type:"Risotto"},
  {name:"Pizza",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Veggie",type:"Pizza"},
  {name:"Salad",days:["Monday","Tuesday","Thursday","Friday","Saturday"],health:5,core:"Veggie",type:"Salad"},
  {name:"Fajitas",days:["Tuesday","Thursday"],health:4,core:"Chicken",type:"Mexican"},
  {name:"Spaghetti Meatballs",days:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Pasta"},
  {name:"Cheese and Biscuits",days:["Friday","Saturday","Sunday"],health:1,core:"Mixed",type:"Snacky"},
  {name:"Buffalo Wing Dip",days:["Saturday","Sunday"],health:1,core:"Chicken",type:"Snacky"},
  {name:"BBQ pasta",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Pasta"},
  {name:"Salmon",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:5,core:"Fish",type:"Asian"},
  {name:"Garlic Noodles",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Mixed",type:"Noodles"},
  {name:"M&S Dine In",days:["Friday","Saturday","Sunday"],health:2,core:"Mixed",type:"Any"},
  {name:"Beef Burgers",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Beef",type:"Burger"},
  {name:"Chicken Burgers",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Chicken",type:"Burger"},
  {name:"Turkey Burgers",days:["Friday","Saturday","Sunday"],health:4,core:"Turkey",type:"Burger"},
  {name:"Pasta Bake",days:["Wednesday"],health:2,core:"Veggie",type:"Pasta"},
  {name:"Enchilades",days:["Tuesday","Thursday"],health:3,core:"Mixed",type:"Mexican"},
  {name:"Burrito Bowls",days:["Tuesday","Thursday"],health:4,core:"Mixed",type:"Mexican"},
  {name:"Bangers and Mash",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Mixed",type:"Heavy"},
  {name:"Tuna Casserole",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:3,core:"Fish",type:"Pasta"},
  {name:"Chicken Mackahani",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Indian"},
  {name:"Chicken Korma",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:2,core:"Chicken",type:"Indian"},
  {name:"Sticky Mushrooms",days:["Friday","Saturday","Sunday"],health:3,core:"Veggie",type:"Asian"},
  {name:"Halloumi Tacos",days:["Monday","Tuesday","Thursday","Friday","Saturday","Sunday"],health:4,core:"Veggie",type:"Mexican"},
];

let currentPlan = [];        // array of {day, meal}
let currentSeed = null;

/* -------------------------
   Deterministic PRNG
   ------------------------- */
function seededRandom(n) {
  // simple deterministic generator based on sin
  const x = Math.sin(n) * 10000;
  return x - Math.floor(x);
}

/* -------------------------
   Meal generation
   ------------------------- */
function generateMealPlan(seed = Math.floor(Math.random() * 999999)) {
  currentSeed = seed;
  const planDiv = document.getElementById("meal-plan");
  planDiv.innerHTML = "";

  let plan = [];
  let healthyCount = 0;
  let localSeed = seed; // will be incremented as we draw, deterministic based on seed

  // We'll attempt full-week generation; if healthy ratio fail, try again (advances localSeed deterministically)
  while (true) {
    plan = [];
    healthyCount = 0;
    let lastCore = null;
    let lastType = null;
    const used = new Set();

    for (let dayIdx = 0; dayIdx < DAYS.length; dayIdx++) {
      const day = DAYS[dayIdx];

      // 1) Try: allowed-day & different core/type from previous & NOT used
      let options = meals.filter(m =>
        m.days.includes(day) &&
        m.core !== lastCore &&
        m.type !== lastType &&
        !used.has(m.name)
      );

      // 2) Fallback A: allowed-day & different core/type (allow used) — keeps variety but allows reuse if pool small
      if (options.length === 0) {
        options = meals.filter(m =>
          m.days.includes(day) &&
          m.core !== lastCore &&
          m.type !== lastType
        );
      }

      // 3) Fallback B: allowed-day & NOT used (ignore core/type)
      if (options.length === 0) {
        options = meals.filter(m =>
          m.days.includes(day) &&
          !used.has(m.name)
        );
      }

      // 4) Final fallback: any allowed-day meal (may duplicate or match core/type)
      if (options.length === 0) {
        options = meals.filter(m => m.days.includes(day));
      }

      // pick deterministic index from options using localSeed
      const idx = Math.floor(seededRandom(localSeed++) * options.length);
      const chosen = options[idx];

      plan.push({ day, meal: chosen });
      used.add(chosen.name);
      lastCore = chosen.core;
      lastType = chosen.type;
      if ((chosen.health || 0) >= 3) healthyCount++;
    }

    // check health ratio requirement (70%)
    if ((healthyCount / DAYS.length) >= 0.7) {
      break;
    }

    // else: loop again — localSeed has advanced so next loop will yield different picks deterministically
  }

  currentPlan = plan;
  saveMealPlan();
  renderPlan();
}

/* -------------------------
   Render & reroll logic
   ------------------------- */
function renderPlan() {
  const planDiv = document.getElementById("meal-plan");
  planDiv.innerHTML = "";
  let healthyCount = 0;

  currentPlan.forEach((entry, index) => {
    if ((entry.meal.health || 0) >= 3) healthyCount++;
    const div = document.createElement("div");
    div.className = "meal";
    div.innerHTML = `<strong>${entry.day}</strong>: ${entry.meal.name}`;
    div.onclick = () => rerollMeal(index, div);
    planDiv.appendChild(div);
  });

  const healthyLabel = document.createElement("div");
  healthyLabel.className = "healthy-label";
  const percent = Math.round((healthyCount / DAYS.length) * 100);
  healthyLabel.textContent = `Healthy meals this week: ${percent}%` + (currentSeed !== null ? ` (Seed #${currentSeed})` : " (Custom)");
  planDiv.appendChild(healthyLabel);
}

function rerollMeal(index, element) {
  // When user rerolls a single day, the plan is now 'custom' — not representable by the saved seed.
  currentSeed = null;

  const day = currentPlan[index].day;
  const prev = currentPlan[index - 1]?.meal;
  const next = currentPlan[index + 1]?.meal;

  let options = meals.filter(m =>
    m.days.includes(day) &&
    m.name !== currentPlan[index].meal.name &&
    m.core !== prev?.core &&
    m.type !== prev?.type &&
    m.core !== next?.core &&
    m.type !== next?.type
  );
  if (options.length === 0) options = meals.filter(m => m.days.includes(day));

  const newMeal = options[Math.floor(Math.random() * options.length)];
  currentPlan[index].meal = newMeal;

  element.classList.add("highlight");
  setTimeout(() => element.classList.remove("highlight"), 400);

  saveMealPlan();
  renderPlan();
}

/* -------------------------
   Save / Load
   ------------------------- */
function saveMealPlan() {
  // Save as a simple mapping day -> mealName for shopping page compatibility
  const mealPlanMap = {};
  currentPlan.forEach(entry => {
    mealPlanMap[entry.day] = entry.meal.name;
  });
  localStorage.setItem('weeklyMealPlan', JSON.stringify(mealPlanMap));

  // Save seed only if it's a pure seed-generated plan
  if (currentSeed !== null && typeof currentSeed !== 'undefined') {
    localStorage.setItem('mealSeed', String(currentSeed));
  } else {
    localStorage.removeItem('mealSeed');
  }
}

/* -------------------------
   Helpers / Navigation
   ------------------------- */
function openShoppingList() {
  if (currentPlan.length === 0) {
    alert("Please generate your meal plan first!");
    return;
  }
  saveMealPlan();
  window.location.href = 'shopping.html';
}

function loadFromSeed() {
  const input = document.getElementById("seedInput").value;
  if (!input) return alert("Enter a seed number first!");
  const seedNum = parseInt(input, 10);
  if (isNaN(seedNum)) return alert("Invalid seed number.");
  generateMealPlan(seedNum);
}

/* -------------------------
   On load: restore saved plan (if any)
   ------------------------- */
window.onload = () => {
  const savedPlan = localStorage.getItem('weeklyMealPlan');
  const savedSeed = localStorage.getItem('mealSeed');
  if (savedPlan) {
    // savedPlan stored as map { "Monday": "Stir Fry", ... }
    try {
      const parsed = JSON.parse(savedPlan);
      currentSeed = (savedSeed ? parseInt(savedSeed, 10) : null);
      currentPlan = DAYS.map(day => {
        const mealName = parsed[day];
        const foundMeal = meals.find(m => m.name === mealName);
        return { day, meal: foundMeal || { name: mealName, health: 0, core: "", type: "" } };
      });
      renderPlan();
      return;
    } catch (e) {
      // fallthrough to generate a new one if parse fails
      console.warn("Failed to parse saved plan:", e);
    }
  }

  // if no saved plan, generate fresh seeded plan
  generateMealPlan();
};
</script>

</body>
</html>
